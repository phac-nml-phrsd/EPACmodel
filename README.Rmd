---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  # eval = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  fig.align = "center",
  out.width = "75%"
)
```

# EPACmodel

<!-- badges: start -->
<!-- badges: end -->

This package implements the Early Pandemic Age-Structured Compartmental (EPAC) model developed by Michael WZ Li ([@wzmli](https://github.com/wzmli)) and Irena Papst ([@papsti](https://github.com/papsti)) from the Public Health Risk Sciences Division of the Public Health Agency of Canada ([@phac-nml-phrsd](https://github.com/phac-nml-phrsd))q using  [`macpan2`](https://github.com/canmod/macpan2) modelling software. 

The goal of this package is to document the iterations of this model, and package them so that they can easily be pulled into project-specific pipelines to produce modelling outputs. 

## Installation

The latest release of `EPACmodel` is [version 1.1.0](https://github.com/phac-nml-phrsd/EPACmodel/releases/tag/v1.1.0), and can be installed with:

```{r eval = FALSE}
remotes::install_github("phac-nml-phrsd/EPACmodel@v1.1.0")
```

You can install the development version of `EPACmodel` with:

```{r eval = FALSE}
remotes::install_github("phac-nml-phrsd/EPACmodel")
```

## Getting started guide

```{r}
library(EPACmodel)
```

### Set up model simulator

To work with a model, we need to set up its simulator. A simulator in `macpan2` is an object that includes model structure (state names, flow expressions, etc.) along with a set of variable values (such as components of flow rates, initial states) that ensure it is ready to produce simulation results. 

This package includes several models whose simulators can quickly and easily be retrieved. Available models include:

```{r}
list_models()
```

To get this model's simulator, we simply call:

```{r}
model.name <- "old-and-young"
model_simulator <- make_simulator(
  model.name = model.name
)
```

By default, `make_simulator()` will attach a set of default values for variables in the model (components of flow rates, initial states, etc.) to the model structure. It will also set a default number of time steps. You can see all default values easily as follows:

```{r}
# load default values (initial state, params, etc.)
default.values = get_default_values(model.name)
```

The definition of each default value is documented in each model's README (appended below in the [Available models](#available-models) section).

Any of these values can be changed by passing the optional `update.values` argument to `make_simulator()`. We recommend first loading the entire list of default values and extracting the specific value (list element) that you want to update, editing the numeric quantity as desired, and then passing the modified list element to `make_simulator()` via the `update.values` argument, to ensure that format of value is preserved to remain compatible with the model definition and `macpan2`:

```{r}
# get default initial state
default.state = default.values$state
print("default state:")
print(default.state)

# move some young susceptibles to the recovered class
new.state = default.state # copy over default value to preserve format
new.state["R_y"] = 1000 # modify specific elements
new.state["S_y"] = new.state["S_y"] - new.state["R_y"] # modify specific elements
print("new state:")
print(new.state)

# use updated state to make a new simulator 
new_model_simulator = make_simulator(
  model.name = model.name,
  updated.values = list(state = new.state)
)
```

### Simulate a model

To simulate a model, just use the `simulate()` function:

```{r}
sim.output = simulate(model_simulator)
```

Since the model simulator already has all required values attached, all required calculations can be performed to produce the simulation results. 

For all models, simulation outputs are stored in a data frame with columns

```
time | state_name | value_type | value
```

The output `value_types` are

- `state`: the number of individuals in given state at a given time,
- `total_inflow`: the total inflow into a given compartment at a given time.

For instance, here is the number of individuals in each state, stratified by the two age groups `y` (young) and `o` (old), at time 10:

```{r}
(sim.output
 |> dplyr::filter(value_type == 'state', time == 10)
)
```

The total inflow into $I$ compartments can be used to extract disease incidence by age over time:

```{r}
(sim.output
 |> dplyr::filter(
   stringr::str_detect(state_name, "^I"),
   value_type == 'total_inflow'
 )
 |> head()
)
```

We can plot the results using standard data manipulation and plotting tools, like `dplyr` and `ggplot2`:

```{r sim-output-1, echo = FALSE}
tidy_output = function(output){
   age.lookup = tibble::tibble(
    age_label = c("y", "o"),
    age = c("young", "old")
  )
   sep.state = "_"
  
  (output
    # parse state names
     |> tidyr::separate(
       state_name,
       into = c("epi_state", "age_label"),
       sep = sep.state
     )
     |> dplyr::left_join(
       age.lookup,
       by = dplyr::join_by(age_label)
     )
     |> dplyr::select(-age_label)
     |> dplyr::filter(value_type == 'total_inflow', epi_state == 'I')
   )
}

plot_output <- function(df, ylim = NULL){
  (df
     |> ggplot2::ggplot()
     + ggplot2::geom_line(ggplot2::aes(x = time, y = value, colour = age),
                          linewidth = 1.25)
     + ggplot2::scale_y_continuous(
       limits = ylim,
       labels = scales::label_number(scale_cut = scales::cut_short_scale())
     )
     + ggplot2::labs(
       x = "Days since start of outbreak",
       title = "Disease incidence over time",
       colour = "Age group"
     )
     + ggplot2::theme_bw(
       base_size = 16
     )
     + ggplot2::theme(
       axis.title.y = ggplot2::element_blank(),
       legend.position = c(1,1),
       legend.justification = c(1,1),
       legend.background = ggplot2::element_rect(fill = NA)
      )
  )
}

(sim.output
  # these are not package functions, defined just for this doc
 |> tidy_output()
 |> plot_output()
)
```

### Scenarios

By default, `make_simulator()` will initialize a base model. Some model definitions include optional scenarios on top of the base model, such as interventions modelled through time-varying model parameters. For instance, one could simulate a stay-at-home order by reducing the transmission rate on a given date by some amount. 

One can specify the `scenario.name` argument in `make_simulator()` to attach the required model structure to simulate a given scenario type. Scenario options and descriptions are catalogued in each model's README (appended below in the [Available models](#available-models) section).

Here we demonstrate the `old-and-young` model with the `transmission-intervention` scenario. By default, this scenario reduces the transmission rate in each age group to 50% then 10% of its original value on days 30 and 40, respectively:

```{r}
values = get_default_values("old-and-young")

values[
  c("intervention.day", "trans.factor.young", "trans.factor.old")
]
```

We specify that we want to use the `change-transmission` scenario in the call to `make_simulator()`:

```{r}
model_simulator <- make_simulator(
  model.name = "old-and-young",
  scenario.name = "change-transmission"
)

sim.output = simulate(model_simulator)
```

```{r sim-output-2, echo = FALSE}
annotation = tibble::tibble(
  x = values$intervention.day,
  y = c(2.45e5, 2e5),
  label = paste0("Change transmission to\n",
                 values$trans.factor.young*100
                 ,"% original value")
)

(sim.output
 |> tidy_output()
 |> plot_output(
   ylim = c(0, 2.6e5)
 )
  # add annotations for interventions
  + ggplot2::geom_vline(
      data = annotation,
      mapping = ggplot2::aes(xintercept = x),
      linewidth = 1.1,
      alpha = 0.25
    )
  + ggplot2::geom_label(
      data = annotation,
      mapping = ggplot2::aes(x = x, y = y, label = label)
    )
)
```

## Available models {#available-models}

```{r, echo = FALSE}
model_readmes <- c()
for (mod in rev(list_models())){
  model_readmes <- c(model_readmes,
                     fs::path_package("models", mod, "README.Rmd",
                                      package = "EPACmodel"))
}
```

```{r, child = model_readmes, echo = FALSE}
```

## Locally-defined model files

You can use the functions in this package with model files defined locally in your own projects, provided they fit the `EPACmodel` paradigm. It is easiest to start with files from a packaged model as a guide (like the [`five-year-age-groups` model files](https://github.com/phac-nml-phrsd/EPACmodel/tree/v1.0.0/inst/models/five-year-age-groups)). 

Here is a list of requirements for locally-defined models:

- Models are defined in a `models/[model-name]` subdirectory of the main project folder (`[model-name]` is a placeholder)
- The following files must appear in `models/[model-name]` to define a model:
    - The standard set of model definition files [required by `macpan2`](https://canmod.github.io/macpan2/articles/quickstart), including:
        - `variables.csv`
        - `derivations.json`
        - `settings.json`
        - `flows.csv`
    - `default_values.rds`, containing a `values` list that includes specific numeric values for all quantities that must be specified for a model simulator to run (_e.g._ parameter values, initial conditions, etc.)
    - `simulator-expression.R`, containing an expression for the model simulator as specified by a `macpan2::TMBSimulator()` object
- The following files may optionally appear in `models/[model-name]` to define a model:
    - `run-before-model.R`, including any code that should be run before the simulator expression, to help initialize it
    - `run-after-model.R`, including any code that should be run after the simulator expression, to modify it, including any scenario-based modifications
    - `README.Rmd`, describing the model and any defined scenarios
- Any helper functions required to generate a model simulator should appear in `R/helpers_[model-name].R`, where `R/` is a subdirectory of the main project folder.

One can use package functions to work with locally-defined models by using the `local = TRUE` flag:

```
list_models(local = TRUE)
make_simulator(model.name = "my-model", local = TRUE)
```
