---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  # eval = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# EPAC model

<!-- badges: start -->
<!-- badges: end -->

This package implements the Early Pandemic Age-Structured Compartmental (EPAC) model developed by [@wzmli](https://github.com/wzmli) and [@papsti](https://github.com/papsti) at [@phac-nml-phrsd](https://github.com/phac-nml-phrsd) using  [`macpan2`](https://github.com/canmod/macpan2) modelling software. **This package is still in development.**

The goal of this package is to document the iterations of this model, so that they can be pulled into project-specific pipelines to produce modelling outputs. 

## Installation

You can install the development version of EPACmodel like so:

``` r
# FILL THIS IN! HOW CAN PEOPLE INSTALL YOUR DEV PACKAGE?
```

## Getting started

```{r}
library(EPACmodel)
```

### Set up model simulator

To work with a model, we need to load its simulator. A simulator in `macpan2` is an object that includes model structure (state names, flows, etc.) along with parameter values and initial states. 

This package includes several models whose simulators can quickly and easily be retrieved. Available models include:

```{r}
list_models()
```

To get this model's simulator, we simply call:

```{r}
model.name <- "two-age-groups"
model_simulator <- make_simulator(
  model.name = model.name
)
```

By default, `make_simulator()` will attach a set of default parameters and initial states to the model structure. It will also set a default number of time steps. Any of these can be changed by passing the optional `update.values` argument to `make_simulator()`. We recommend first loading the default parameters and/or states, and then editing the values in these lists in-session, to ensure the format of each object is compatible with the model definition and `macpan2`:

```{r}
# load default values (inital state, params, etc.)
default.values = get_default_values(model.name)
default.state = default.values$state
print("default state:")
print(default.state)

# move some young susceptibles to the recovered class
new.state = default.state
new.state["R_y"] = 1000
new.state["S_y"] = default.state["S_y"] - new.state["R_y"]
print("new state:")
print(new.state)
```

Now we pass the modified params and/or state to `make_simulator()`:

```{r}
new_model_simulator = make_simulator(
  model.name = model.name,
  updated.values = list(state = new.state)
)
```

### Simulate base model

To run the simulation:

```{r}
sim_output = simulate(model_simulator)
```

This output will include the value of each state at the given time (`value_type == 'state')`:

```{r}
(sim_output
 |> dplyr::filter(value_type == 'state', time == 10)
 |> head()
)
```

as well as the inflow into each compartment at a given time (`value_type == 'total_inflow')`, so that one could look at incidence, for instance:

```{r}
(sim_output
 |> dplyr::filter(value_type == 'total_inflow', time == 10)
 |> head()
)
```

We can plot the results using standard data manipulation and plotting tools:

```{r}
tidy_output = function(output){
   age.lookup = tibble::tibble(
    age_label = c("y", "o"),
    age = c("young", "old")
  )
   sep.state = "_"
  
  (output
    # parse state names
     |> tidyr::separate(
       state_name,
       into = c("epi_state", "age_label"),
       sep = sep.state
     )
     |> dplyr::left_join(
       age.lookup,
       by = dplyr::join_by(age_label)
     )
     |> dplyr::select(-age_label)
     |> dplyr::filter(value_type == 'total_inflow', epi_state == 'I')
   )
}

plot_output <- function(df){
  (df
     |> ggplot2::ggplot()
     + ggplot2::geom_line(ggplot2::aes(x = time, y = value, colour = age),
                          linewidth = 1.25)
     + ggplot2::scale_y_continuous(
       labels = scales::label_number(scale_cut = scales::cut_short_scale())
     )
     + ggplot2::labs(
       x = "Days since start of outbreak",
       title = "Incidence over time by age group"
     )
     + ggplot2::theme_bw()
     + ggplot2::theme(
       axis.title.y = ggplot2::element_blank(),
       legend.position = c(1,1),
       legend.justification = c(1,1),
       legend.background = ggplot2::element_rect(fill = NA)
      )
  )
}
```

```{r sim-output-1}
(sim_output
 |> tidy_output()
 |> plot_output()
)
```

### Scenarios

By default, `make_simulator()` will initialize a base model. Some model definitions include optional scenarios on top of the base model, such as interventions modelled through time-varying model parameters. For instance, one could simulate a stay-at-home order by reducing the transmission rate on a given date by some amount. 

One can specify the `scenario.name` argument in `make_simulator()` to attach the required model structure to simulate a given scenario type. Scenario options are catalogued in each model's README (appended below in the [Available models](#available-models) section.

Here we demonstrate the `two-age-groups` model with the `transmission-intervention` scenario. By default, this scenario reduces the transmission rate in each age group to 50% then 10% of its original value on days 30 and 40, respectively:

```{r}
values = get_default_values("two-age-groups")

values[
  c("intervention.day", "trans.factor.young", "trans.factor.old")
]
```

```{r sim-output-2}
model_simulator <- make_simulator(
  model.name = "two-age-groups",
  scenario.name = "change-transmission"
)

sim_output = simulate(model_simulator)

annotation = tibble::tibble(
  x = values$intervention.day,
  y = c(1.5e5, 7.5e4),
  label = paste0("Change transmission to\n",
                 values$trans.factor.young*100
                 ,"% original value")
)

(sim_output
 |> tidy_output()
 |> plot_output()
  # add annotations for interventions
  + ggplot2::geom_vline(
      data = annotation,
      mapping = ggplot2::aes(xintercept = x),
      linetype = "dashed",
      alpha = 0.5
    )
  + ggplot2::geom_label(
      data = annotation,
      mapping = ggplot2::aes(x = x, y = y, label = label),
      alpha = 0.5,
      size = 2.5
    )
)
```


## Available models {#available-models}

```{r, echo = FALSE}
model_readmes <- c()
for (mod in list_models()){
  model_readmes <- c(model_readmes,
                     fs::path_package("models", mod, "README.Rmd",
                                      package = "EPACmodel"))
}
```

```{r, child = model_readmes, echo = FALSE}
```
